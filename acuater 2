// src/main/java/com/example/demo/metrics/UniqueUserInterceptor.java
package com.example.demo.metrics;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.Gauge;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.annotation.PostConstruct;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.time.LocalDate;
import java.util.Set;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class UniqueUserInterceptor implements HandlerInterceptor {

    private static final String COOKIE_NAME = "CLIENT_ID";
    private final MeterRegistry registry;
    private final Set<String> seen = ConcurrentHashMap.newKeySet();

    public UniqueUserInterceptor(MeterRegistry registry) {
        this.registry = registry;
    }

    @PostConstruct
    public void initGauge() {
        Gauge.builder("app.unique.users.current", seen, Set::size)
             .description("Current distinct users seen so far today")
             .register(registry);
    }

    @Override
    public boolean preHandle(HttpServletRequest req, HttpServletResponse res, Object handler) {
        // 1) look for CLIENT_ID cookie
        String clientId = null;
        Cookie[] cookies = req.getCookies();
        if (cookies != null) {
            for (Cookie c : cookies) {
                if (COOKIE_NAME.equals(c.getName())) {
                    clientId = c.getValue();
                    break;
                }
            }
        }
        // 2) if missing, generate and set a cookie
        if (clientId == null) {
            clientId = UUID.randomUUID().toString();
            Cookie cookie = new Cookie(COOKIE_NAME, clientId);
            cookie.setPath("/");
            cookie.setHttpOnly(true);
            cookie.setMaxAge(60 * 60 * 24 * 365); // 1 year
            res.addCookie(cookie);
        }
        // use clientId as key; count once per day
        String key = clientId + "-" + LocalDate.now();
        if (seen.add(key)) {
            Counter.builder("app.unique.users.daily")
                   .description("Distinct users per day")
                   .tag("date", LocalDate.now().toString())
                   .register(registry)
                   .increment();
        }
        return true;
    }

    /** Clear at midnight so tomorrow starts fresh */
    @Scheduled(cron = "0 0 0 * * *")
    public void resetDaily() {
        seen.clear();
    }
}














-------------------------------------


// src/main/java/com/example/demo/config/WebConfig.java
package com.example.demo.config;

import com.example.demo.metrics.UniqueUserInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    private final UniqueUserInterceptor uniqueUserInterceptor;

    public WebConfig(UniqueUserInterceptor uniqueUserInterceptor) {
        this.uniqueUserInterceptor = uniqueUserInterceptor;
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(uniqueUserInterceptor)
                .addPathPatterns("/api/**");   // adjust to your API paths
    }
}








----------------------------


<dependencies>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
  </dependency>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
  </dependency>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
  </dependency>
  <dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
  </dependency>
</dependencies>
