
server {
    listen 1991;
    server_name jo00-cmon04;

    # redirect all http requests to https
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    # root /var/www/html;
    # index index.html index.htm index.nginx-debian.html;
    server_name jo00-cmon04;

    ssl_certificate /etc/nginx/ssl/public.crt;
    ssl_certificate_key /etc/nginx/ssl/private.key;
    # ssl_certificate      /etc/nginx/ssl/server.crt;
    # ssl_certificate_key  /etc/nginx/ssl/server.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;
    ssl_prefer_server_ciphers on;

   location /_next/static/ {
       alias /data/apps/cmon-dashboard/frontend/.next/static/;
       expires 1d;
       access_log off;
   }

    location /{
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3009;
    }

    location /one-view {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3009/one-view;
    }

    location /database-monitoring {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3009/database-monitoring;
    }

    location /cmon-api/ {
        proxy_pass https://127.0.0.1:9448/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # omnify API route

   location /omnify/_next/static/ {
   	alias /data/apps/dig-dashboard/frontend/.next/static/;
   	expires 1d;
   	access_log off;
   }


   location /omnify/ {
   	rewrite ^/omnify/(.*)$ /$1 break;
   	proxy_pass http://127.0.0.1:3003/;
   	proxy_set_header Host $host;
   	proxy_set_header X-Real-IP $remote_addr;
   	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   	proxy_set_header X-Forwarded-Proto $scheme;
   	proxy_set_header Upgrade $http_upgrade;
   	proxy_set_header Connection 'upgrade';
   }

    # helios API route

    location /helios/_next/static/ {
   	alias /data/apps/dig-dashboard/frontend/.next/static/;
        expires 1d;
        access_log off;
    }

    location /helios {
	rewrite ^/helios/(.*)$ /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
	proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3003/helios;  # Helios frontend
    }

    # EAB API route

    location /eab/_next/static/ {
   	alias /data/apps/dig-dashboard/frontend/.next/static/;
        expires 1d;
        access_log off;
    }

    location /eab {
	rewrite ^/eab/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3003/;  # EAB frontend
    }


    location /digital/eab {
	rewrite ^/eab/(.*)$ /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
	proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3003/digital/eab;  # EAB frontend
    }


	# unauthorized 

    location /unauthorized/_next/static/ {
   	alias /data/apps/dig-dashboard/frontend/.next/static/;
        expires 1d;
        access_log off;
    }

    location /digital/unauthorized {
	rewrite ^/unauthorized/(.*)$ /$1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
	proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3003/digital/unauthorized ;  # unauthorized frontend
    }

    # dig-api route
    location /dig-api/ {
        proxy_pass http://127.0.0.1:9451/;  # dig-api backend
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # DR API route
    location /dr {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
	proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3004/dr;  # DR frontend
    }


    # dig-api route
    location /dr-api/ {
        proxy_pass http://127.0.0.1:9451/;  # dr-api backend
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }


    # MDM API route
    location /mdm {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
	proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://127.0.0.1:3005/mdm;  # mdm frontend
    }


    # mdm-api route
    location /mdm-api/ {
        proxy_pass http://127.0.0.1:9447/;  # mdm-api backend
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    location /cmon-auth-api/ {
        proxy_pass http://127.0.0.1:9444/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    location /cmon-glowroot/ {
        proxy_pass http://127.0.0.1:3001/transaction;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    location /cmon-glowroot-admin/ {
        proxy_pass http://127.0.0.1:3001/login;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    location /admin/general/ {
        proxy_pass http://127.0.0.1:3001/admin/general;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }
}




/////////////////////////////////////////////////////////


server {
    listen 1991;
    server_name jo00-cmon04;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name jo00-cmon04;

    ssl_certificate /etc/nginx/ssl/public.crt;
    ssl_certificate_key /etc/nginx/ssl/private.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;
    ssl_prefer_server_ciphers on;

    # ===============================
    # Static File Proxies (Next.js)
    # ===============================

    # For base: /_next/static/ (from port 3009)
    location /_next/static/ {
        proxy_pass http://127.0.0.1:3009/_next/static/;
        expires 1d;
        access_log off;
    }

    # For prefixed apps (helios, eab, omnify, unauthorized from port 3003)
    location ~ ^/(helios|eab|unauthorized|omnify)/_next/static/ {
        proxy_pass http://127.0.0.1:3003$request_uri;
        expires 1d;
        access_log off;
    }

    # ======================
    # Dashboard Main Routes
    # ======================

    location / {
        proxy_pass http://127.0.0.1:3009;
        include proxy_params;
    }

    location /one-view {
        proxy_pass http://127.0.0.1:3009/one-view;
        include proxy_params;
    }

    location /database-monitoring {
        proxy_pass http://127.0.0.1:3009/database-monitoring;
        include proxy_params;
    }

    # =================
    # CMON APIs
    # =================

    location /cmon-api/ {
        proxy_pass https://127.0.0.1:9448/;
        include secure_proxy_params;
    }

    location /cmon-auth-api/ {
        proxy_pass http://127.0.0.1:9444/;
        include secure_proxy_params;
    }

    location /cmon-glowroot/ {
        proxy_pass http://127.0.0.1:3001/transaction;
        include secure_proxy_params;
    }

    location /cmon-glowroot-admin/ {
        proxy_pass http://127.0.0.1:3001/login;
        include secure_proxy_params;
    }

    location /admin/general/ {
        proxy_pass http://127.0.0.1:3001/admin/general;
        include secure_proxy_params;
    }

    # =====================
    # DIG Dashboard (port 3003)
    # =====================

    location /omnify/ {
        rewrite ^/omnify/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3003/;
        include proxy_params;
    }

    location /helios {
        rewrite ^/helios/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3003/helios;
        include proxy_params;
    }

    location /eab {
        rewrite ^/eab/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3003/;
        include proxy_params;
    }

    location /digital/eab {
        rewrite ^/eab/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3003/digital/eab;
        include proxy_params;
    }

    location /digital/unauthorized {
        rewrite ^/unauthorized/(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:3003/digital/unauthorized;
        include proxy_params;
    }

    # =========================
    # DIG APIs (Backend ports)
    # =========================

    location /dig-api/ {
        proxy_pass http://127.0.0.1:9451/;
        include secure_proxy_params;
    }

    location /dr-api/ {
        proxy_pass http://127.0.0.1:9451/;
        include secure_proxy_params;
    }

    location /dr {
        proxy_pass http://127.0.0.1:3004/dr;
        include proxy_params;
    }

    location /mdm {
        proxy_pass http://127.0.0.1:3005/mdm;
        include proxy_params;
    }

    location /mdm-api/ {
        proxy_pass http://127.0.0.1:9447/;
        include secure_proxy_params;
    }
}

# ============================
# Embedded proxy param blocks
# ============================

# Include this manually at the bottom or in a separate file:
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Proxy Params
# ------------
# Add these in /etc/nginx/conf.d/proxy_params.conf or inline:
# (used with include proxy_params;)
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;

# Secure Proxy Params
# -------------------
# (used with include secure_proxy_params;)
proxy_http_version 1.1;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
proxy_cache_bypass $http_upgrade;
